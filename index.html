<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Aurelia</title>
  </head>

  <body aurelia-app="main">
    <script data-main="aurelia-bootstrapper" async>
      (function(document, localStorage) {
        var _cachedVendorBundle = null
        var _database = null
        var _head = document.getElementsByTagName('head')[0]
        var _scripts = []

        loadScript([
          'https://www.gstatic.com/firebasejs/3.6.10/firebase-app.js',
          'https://www.gstatic.com/firebasejs/3.6.10/firebase-database.js',
        ]).then(function() {
          firebase.initializeApp({ databaseURL: 'https://pyro-dd68b.firebaseio.com' })
          _database = firebase.database()
          determineRequiredBundles()
          loadRequiredBundles()
        })

        function determineRequiredBundles() {
          _cachedVendorBundle = localStorage.getItem('vendor-bundle')
          if (!_cachedVendorBundle) {
            _scripts.push(firebase.database().ref('/vendor-bundle').once('value'))
          }
          _scripts.push(firebase.database().ref('/app-bundle').once('value'))
        }

        function loadRequiredBundles() {
          var s = document.createElement('script')
          return Promise.all(_scripts).then(function(snapshots) {
            if (_scripts.length === 1) {
              console.debug('using cached vendor-bundle')
              s.innerHTML = _cachedVendorBundle + snapshots[0].val()
            }  else if (_scripts.length === 2) {
              console.warn('vendor-bundle not found, caching new version')
              localStorage.setItem('vendor-bundle', snapshots[0].val())
              s.innerHTML = snapshots[0].val() + snapshots[1].val()
            } else {
              throw new Error('Miscalculated scripts')
            }
            _head.parentNode.insertBefore(s, _head)
          })
        }

        function loadScript(options) {
          if (Array.isArray(options)) {
            var promises = []
            options.forEach(function(item) {
              promises.push(loadScript(item, options))
            })
            return Promise.all(promises)
          }

          return new Promise(function(resolve, reject) {
            var r = false, s = document.createElement('script')
            s.type = 'text/javascript'
            s.onerror = s.onabort = reject
            s.onload = s.onreadystatechange = function() {
              if (!r && (!this.readyState || this.readyState == 'complete')) {
                r = true
                resolve(this)
              }
            }
            if (typeof options === 'object' && typeof options.src !== 'undefined') {
              for (key in options) {
                s[key] = options[key]
              }
            } else if (typeof options === 'string') {
              s.src = options
            } else {
              throw new Error('Script source undefined')
            }
            _head.parentNode.insertBefore(s, _head)
          })
        }
      })(document, localStorage)
    </script>
  </body>
</html>
